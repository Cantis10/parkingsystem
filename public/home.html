<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Website</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
   
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top rounded-bottom-lg">
        <div class="container-fluid justify-content-end">
            <div id="loginButton">
                <a href="/login" class="btn btn-outline-light me-3">Login</a>
            </div>

            <a class="navbar-brand d-flex align-items-center" href="#">
                Urban parker<i class="fas fa-bell ms-2"></i>
            </a>
            </div>
    </nav>

    <div class="sidebar">
        <a href="#" class="sidebar-icon rounded-pill">
            <i class="fas fa-home"></i>
        </a>
        <a href="#" class="sidebar-icon rounded-pill">
            <i class="fas fa-user"></i>
        </a>
        <a href="#" class="sidebar-icon rounded-pill">
            <i class="fas fa-cog"></i>
        </a>
        <a href="#" id="search-icon-row" class="sidebar-icon rounded-pill">
            <i class="fas fa-search"></i>
        </a>
    </div>

    <div id="search-popup" class="popup-bubble">
        <span id="close-popup" class="close-btn">&times;</span>
        <h5 class="mb-3">Filter Cards</h5>
        <form id="filter-form">
            <div class="mb-3">
                <label for="filter-name" class="form-label">Name</label>
                <input type="text" class="form-control" id="filter-name" placeholder="Enter name">
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="" id="filter-include-zero-spots">
                <label class="form-check-label" for="filter-include-zero-spots">
                    Show cards with no spots
                </label>
            </div>
            <div class="mb-3">
                <label for="filter-min-price" class="form-label">Price Range (PHP)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="filter-min-price" min="0" placeholder="Min">
                    <span class="input-group-text">-</span>
                    <input type="number" class="form-control" id="filter-max-price" min="0" placeholder="Max">
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 mb-2">Filter</button>
            <button type="button" id="clear-filters-btn" class="btn btn-secondary w-100">Clear Filters</button>
        </form>
    </div>

    <div class="content">
        <h1 class="mb-4">Welcome!</h1>
        <div id="card-container" class="row">
        </div>
    </div>

      <div id="output">Loading...</div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Generate a dataset for the cards
            const cardData = [];
            const names = [
                "Park - Quezon city Branch",
            ];
            const images = [
                "images/shop.png",

            ];
            const redirects = [
                "/map",
            ]

            const slots = [
                1,
            ]

            for (let i = 0; i < names.length; i++) {
                cardData.push({
                    name: names[i],
                    availableSpots: slots[i],
                    price: Math.random() * 1000,
                    image: images[i],
                    redirect: redirects[i]
                });
            }

            // Function to generate a single card from data
            function createCard(data) {
                const numBgColor = data.availableSpots > 0 ? 'green' : 'red';
                const formattedCurrency = new Intl.NumberFormat('en-PH', {
                    style: 'currency',
                    currency: 'PHP'
                }).format(data.price);

                // If available, wrap with <a>
                const cardContent = `
        <div class="card h-100 ${data.availableSpots > 0 ? 'card-hover' : 'disabled'}">
            <img src="${data.image}" class="card-img-top" alt="${data.name}">

            <div class="card-body">
                <h5 class="card-title text-center my-3">${data.name}</h5>
                <div class="row">
                    <div class="col text-center py-2" style="background-color: ${numBgColor}; color: white;">
                        ${data.availableSpots}
                    </div>
                    <div class="col text-center text-secondary py-2">
                        ${formattedCurrency}
                    </div>
                    <div class="col text-center py-2">
                        <i class="fas fa-comment fa-lg text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    `;

                if (data.availableSpots > 0) {
                    // clickable
                    return `
            <div class="col-12 col-md-6 col-lg-4 mb-4">
                <a href="${data.redirect}" class="text-decoration-none text-dark">
                    ${cardContent}
                </a>
            </div>
        `;
                } else {
                    // not clickable
                    return `
            <div class="col-12 col-md-6 col-lg-4 mb-4">
                ${cardContent}
            </div>
        `;
                }
            }


            // Function to render cards to the page
            function renderCards(cardsToRender) {
                $('#card-container').empty();
                if (cardsToRender.length > 0) {
                    cardsToRender.forEach(card => {
                        $('#card-container').append(createCard(card));
                    });
                } else {
                    $('#card-container').append('<div class="col-12 text-center text-muted">No cards found matching the criteria.</div>');
                }
            }

            // Initial rendering of all cards
            renderCards(cardData);

            // Pop-up logic
            const $searchIconRow = $('#search-icon-row');
            const $searchPopup = $('#search-popup');
            const $closeBtn = $('#close-popup');

            function togglePopup() {
                $searchPopup.toggleClass('is-open');

                if ($searchPopup.hasClass('is-open')) {
                    const iconPosition = $searchIconRow.offset();
                    const iconWidth = $searchIconRow.outerWidth();
                    $searchPopup.css({
                        top: iconPosition.top,
                        left: iconPosition.left + iconWidth
                    });
                }
            }

            $searchIconRow.on('click', function (e) {
                e.preventDefault();
                togglePopup();
            });

            $closeBtn.on('click', function (e) {
                e.stopPropagation();
                togglePopup();
            });

            $searchPopup.on('click', function (e) {
                // Do not close if a form element is clicked
                if ($(e.target).is('form, input, label, button')) {
                    e.stopPropagation();
                } else {
                    togglePopup();
                }
            });

            // Filter form submission logic
            $('#filter-form').on('submit', function (e) {
                e.preventDefault();
                const nameFilter = $('#filter-name').val().toLowerCase();
                const includeZeroSpots = $('#filter-include-zero-spots').is(':checked');
                const minPriceFilter = parseFloat($('#filter-min-price').val());
                const maxPriceFilter = parseFloat($('#filter-max-price').val());

                const filteredCards = cardData.filter(card => {
                    const nameMatch = card.name.toLowerCase().includes(nameFilter);
                    const spotsMatch = includeZeroSpots ? (card.availableSpots >= 0) : (card.availableSpots > 0);

                    const priceMatch = (isNaN(minPriceFilter) || card.price >= minPriceFilter) &&
                        (isNaN(maxPriceFilter) || card.price <= maxPriceFilter);

                    return nameMatch && spotsMatch && priceMatch;
                });

                renderCards(filteredCards);
                togglePopup();
            });

            // Clear filters logic
            $('#clear-filters-btn').on('click', function () {
                $('#filter-form').trigger("reset");
                renderCards(cardData);
                togglePopup();
            });
        });

        $(document).ready(function() {
    function refreshData() {
      $.get("/json-data", function(data) {
        $("#output").html(`
          <p>${data.message}</p>
          <p>Server time: ${data.time}</p>
        `);
      });
    }

    refreshData();             // load immediately
    setInterval(refreshData, 5000); // refresh every 5s
  });


    $(document).ready(function () {
        // Check login status and update login button
        $.get('/api/auth/check', function(data) {
            if (data.isLoggedIn) {
                // Get user data to include in login URL
                $.get('/api/auth/user', function(userData) {
                    const loginUrl = `/login?email=${encodeURIComponent(userData.email)}&pass=${encodeURIComponent(userData.password)}`;
                    $('#loginButton a').attr('href', loginUrl);
                });
            }
        });
    });



    </script>

</body>

</html>