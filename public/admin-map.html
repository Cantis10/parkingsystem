<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Parking Map</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    .parking-space {
      position: absolute;
      background-color: rgba(0, 123, 255, 0.4);
      border: 2px solid blue;
      z-index: 10;
      cursor: pointer;
      transition: all 0.2s;
    }
    .parking-space:hover {
      border-color: #ffc107;
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
    }
    .parking-space.state-taken {
      background-color: rgba(220, 53, 69, 0.6);
      border: 2px solid red;
    }
    .parking-space.state-available {
      background-color: rgba(40, 167, 69, 0.6);
      border: 2px solid green;
    }
    .map-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }
    .map-image {
      width: 100%; height: 100%;
      display: block;
    }
    .admin-badge {
      position: fixed;
      top: 80px;
      right: 20px;
      background: #ffc107;
      color: #000;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top rounded-bottom-lg">
    <div class="container-fluid">
      <a href="/home" class="btn btn-outline-light d-flex align-items-center me-auto" style="border:none;">
        <i class="fas fa-caret-left fa-lg me-1"></i> Back
      </a>
      <div class="ms-auto">
        <a class="navbar-brand d-flex align-items-center" href="#">
          Master Parker (Admin)
        </a>
      </div>
    </div>
  </nav>

  <div class="admin-badge">
    <i class="fas fa-user-shield"></i> Admin Mode
  </div>

  <div class="mapContainer">
    <div class="map-main-container">
      <div id="map-wrapper" style="position:relative; padding-top:80px;">
        <img class="map-sizer" src="https://placehold.co/1200x800/transparent/000?text=Parking%20Map%20Sizer" alt="Map Sizing Element">
        <div id="map-container-1" class="map-container">
          <img class="map-image" src="images/map/placeHolder.png" alt="Parking Map">
        </div>
        <div id="map-container-2" class="map-container" style="display:none;">
          <img class="map-image" src="images/map/placeHolder.png" alt="Parking Map">
        </div>
      </div>
    </div>
  </div>
  
  <div class="floor-controls">
    <button id="floor-up" class="btn btn-primary shadow">▲</button>
    <div id="floor-display" class="shadow-sm">--</div>
    <button id="floor-down" class="btn btn-primary shadow">▼</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function() {
      const urlParams = new URLSearchParams(window.location.search);
      const locationId = urlParams.get('location_id');

      if (!locationId) {
        alert('No location selected. Redirecting to home.');
        window.location.href = '/home';
        return;
      }

      let mapData = { maps: [], floors: [] };
      let parkingSpaces = [];
      let currentFloorIndex = 0;
      let activeContainerSelector = '#map-container-1';

      // Verify admin access
      $.ajax({
        url: '/api/auth/user',
        method: 'GET',
        success: function(userData) {
          if (userData.role !== 'admin' || parseInt(userData.location_index_admin) !== parseInt(locationId)) {
            alert('Access denied. Admin privileges required for this location.');
            window.location.href = '/home';
          }
        },
        error: function() {
          alert('Authentication failed.');
          window.location.href = '/login';
        }
      });

      function fetchMaps(callback) {
        $.ajax({
          url: `/api/maps/${locationId}`,
          method: 'GET',
          success: function(data) {
            mapData.maps = data.map(m => `/images/map/${m.floorsImageIndex}`);
            mapData.floors = data.map(m => m.floor);
            if (callback) callback();
          },
          error: function(xhr) {
            console.error('Failed to fetch maps:', xhr);
            alert('Failed to load maps for this location.');
          }
        });
      }

      function fetchParkingSpaces(callback) {
        $.ajax({
          url: `/api/parking/${locationId}`,
          method: 'GET',
          success: function(data) {
            parkingSpaces = data;
            if (callback) callback();
          },
          error: function(xhr) {
            console.error('Failed to fetch parking spaces:', xhr);
          }
        });
      }

      function loadFloor(index, containerSelector) {
        if (mapData.floors.length === 0) return;

        const floor = mapData.floors[index];
        const $container = $(containerSelector);

        $container.find('.map-image').attr('src', mapData.maps[index]);
        $('#floor-display').text(`Floor: ${floor}`);

        $container.find('.parking-space').remove();

        parkingSpaces
          .filter(space => space.floor === floor)
          .forEach(space => {
            const spaceDiv = $('<div>', {
              'class': `parking-space state-${space.state}`,
              'data-index': space.index,
              'title': `Space #${space.index} | State: ${space.state} | Type: ${space.feature} | Price: PHP ${parseFloat(space.price).toFixed(2)}`
            }).css({
              top: `${space.locationY}%`,
              left: `${space.locationX}%`,
              width: `${space.sizeX}%`,
              height: `${space.sizeY}%`
            });

            $container.append(spaceDiv);
          });

        $container.find('.parking-space').tooltip({
          content: function () { return $(this).prop('title'); }
        });

        updateButtonStates();
      }

      function updateButtonStates() {
        $('#floor-up').prop('disabled', currentFloorIndex >= mapData.floors.length - 1);
        $('#floor-down').prop('disabled', currentFloorIndex <= 0);
      }

      $('#floor-up').on('click', function() {
        if (currentFloorIndex >= mapData.floors.length - 1) return;
        const newContainer = (activeContainerSelector === '#map-container-1') ? '#map-container-2' : '#map-container-1';
        currentFloorIndex++;
        loadFloor(currentFloorIndex, newContainer);
        $(activeContainerSelector).hide();
        $(newContainer).show();
        activeContainerSelector = newContainer;
      });

      $('#floor-down').on('click', function() {
        if (currentFloorIndex <= 0) return;
        const newContainer = (activeContainerSelector === '#map-container-1') ? '#map-container-2' : '#map-container-1';
        currentFloorIndex--;
        loadFloor(currentFloorIndex, newContainer);
        $(activeContainerSelector).hide();
        $(newContainer).show();
        activeContainerSelector = newContainer;
      });

      $('#map-wrapper').on('click', '.parking-space', function () {
        const idx = $(this).data('index');
        const space = parkingSpaces.find(s => s.index == idx);
        if (!space) return;

        // Populate modal with current values
        $('#edit-index').val(space.index);
        $('#edit-location-x').val(space.locationX);
        $('#edit-location-y').val(space.locationY);
        $('#edit-width').val(space.sizeX);
        $('#edit-height').val(space.sizeY);
        $('#edit-floor').val(space.floor);
        $('#edit-price').val(space.price);
        $('#edit-state').val(space.state);
        $('#edit-exclusive').val(space.feature);
        $('#edit-plate').val(space.plate || '');
        $('#edit-days').val(space.daysToOccupy || 0);
        $('#edit-restriction-start').val(space.restrictionStart || '');
        $('#edit-restriction-end').val(space.restrictionEnd || '');
        $('#edit-restriction-frequency').val(space.restrictionFrequency || 0);

        $('#adminEditModal').modal('show');
      });

      $('#admin-save').on('click', function (e) {
        e.preventDefault();

        const updatedSpace = {
          index: $('#edit-index').val(),
          location_x: parseInt($('#edit-location-x').val(), 10),
          location_y: parseInt($('#edit-location-y').val(), 10),
          width: parseInt($('#edit-width').val(), 10),
          height: parseInt($('#edit-height').val(), 10),
          floor: parseInt($('#edit-floor').val(), 10),
          price: parseFloat($('#edit-price').val()),
          state: $('#edit-state').val(),
          exclusive: $('#edit-exclusive').val(),
          plate: $('#edit-plate').val() || null,
          days_to_occupy: parseInt($('#edit-days').val(), 10) || 0,
          restriction_start: $('#edit-restriction-start').val() || null,
          restriction_end: $('#edit-restriction-end').val() || null,
          restriction_frequency: parseInt($('#edit-restriction-frequency').val(), 10) || 0
        };

        $.ajax({
          url: '/api/admin/parking/update',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(updatedSpace),
          success: function () {
            alert('Parking space updated successfully!');
            fetchParkingSpaces(function() {
              loadFloor(currentFloorIndex, activeContainerSelector);
              $('#adminEditModal').modal('hide');
            });
          },
          error: function (xhr) {
            alert('Failed to update parking space: ' + (xhr.responseJSON?.error || 'Unknown error'));
          }
        });
      });

      // Initialize
      fetchMaps(function() {
        fetchParkingSpaces(function() {
          if (mapData.floors.length > 0) {
            loadFloor(currentFloorIndex, activeContainerSelector);
          } else {
            alert('No maps available for this location.');
          }
        });
      });
    });
  </script>

  <!-- Admin Edit Modal -->
  <div class="modal fade" id="adminEditModal" tabindex="-1" aria-labelledby="adminEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 id="adminEditModalLabel" class="modal-title"><i class="fas fa-edit"></i> Edit Parking Space (Admin)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="admin-edit-form">
            <input type="hidden" id="edit-index">
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="edit-location-x" class="form-label">Location X (%)</label>
                <input type="number" class="form-control" id="edit-location-x" step="0.1" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="edit-location-y" class="form-label">Location Y (%)</label>
                <input type="number" class="form-control" id="edit-location-y" step="0.1" required>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="edit-width" class="form-label">Width (%)</label>
                <input type="number" class="form-control" id="edit-width" step="0.1" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="edit-height" class="form-label">Height (%)</label>
                <input type="number" class="form-control" id="edit-height" step="0.1" required>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="edit-floor" class="form-label">Floor</label>
                <input type="number" class="form-control" id="edit-floor" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="edit-price" class="form-label">Price (PHP)</label>
                <input type="number" class="form-control" id="edit-price" step="0.01" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="edit-state" class="form-label">State</label>
                <select class="form-select" id="edit-state" required>
                  <option value="available">Available</option>
                  <option value="taken">Taken</option>
                  <option value="unavailable">unavailable</option>
                  <option value="reserved">Reserved</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="edit-exclusive" class="form-label">Exclusive Type</label>
                <select class="form-select" id="edit-exclusive" required>
                  <option value="normal">Normal</option>
                  <option value="admin">Admin Only</option>
                  <option value="vip">VIP Only</option>
                  <option value="disabled">Disabled</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="edit-plate" class="form-label">License Plate</label>
                <input type="text" class="form-control" id="edit-plate" placeholder="Leave empty if available">
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="edit-days" class="form-label">Days to Occupy</label>
                <input type="number" class="form-control" id="edit-days" min="0" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label for="edit-restriction-start" class="form-label">Restriction Start</label>
                <input type="time" class="form-control" id="edit-restriction-start">
              </div>
              <div class="col-md-4 mb-3">
                <label for="edit-restriction-end" class="form-label">Restriction End</label>
                <input type="time" class="form-control" id="edit-restriction-end">
              </div>
            </div>

            <div class="mb-3">
              <label for="edit-restriction-frequency" class="form-label">Restriction Frequency (days)</label>
              <input type="number" class="form-control" id="edit-restriction-frequency" min="0" value="0">
              <small class="form-text text-muted">0 = No restriction, 1 = Daily, 7 = Weekly, etc.</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" id="admin-save" class="btn btn-warning"><i class="fas fa-save"></i> Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>