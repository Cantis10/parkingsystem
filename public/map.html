<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Parking Map</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        .parking-space {
            position: absolute;
            background-color: rgba(0, 123, 255, 0.4);
            border: 1px solid blue;
            z-index: 10;
            cursor: pointer;
        }

        .parking-space.state-occupied {
            background-color: rgba(220, 53, 69, 0.6);
            border: 1px solid red;
        }

        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .map-image {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top rounded-bottom-lg">
        <div class="container-fluid">
            <a href="/home" class="btn btn-outline-light d-flex align-items-center me-auto" style="border:none;">
                <i class="fas fa-caret-left fa-lg me-1"></i> Back
            </a>
            <div class="ms-auto">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    Master Parker</i>
                </a>
            </div>
        </div>
    </nav>

    <div class="mapContainer">
        <div class="map-main-container">
            <div id="map-wrapper" style="position:relative; padding-top:80px;">
                <img class="map-sizer" src="https://placehold.co/1200x800/transparent/000?text=Parking%20Map%20Sizer"
                    alt="Map Sizing Element">
                <div id="map-container-1" class="map-container">
                    <img class="map-image" src="images/map/placeHolder.png" alt="Parking Map">
                </div>
                <div id="map-container-2" class="map-container" style="display:none;">
                    <img class="map-image" src="images/map/placeHolder.png" alt="Parking Map">
                </div>
            </div>
        </div>
    </div>

    <div class="floor-controls">
        <button id="floor-up" class="btn btn-primary shadow">▲</button>
        <div id="floor-display" class="shadow-sm">--</div>
        <button id="floor-down" class="btn btn-primary shadow">▼</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            console.log('--- Initializing Parking Map Application ---');

            const urlParams = new URLSearchParams(window.location.search);
            const locationId = urlParams.get('location_id');
            if (!locationId) {
                alert('No location selected. Redirecting to home.');
                window.location.href = '/home';
                return;
            }

            let user = null;
            let mapData = { maps: [], floors: [] };
            let parkingSpaces = [];
            let currentFloorIndex = 0;
            let activeContainerSelector = '#map-container-1';

            // 🧠 Fetch logged-in user info
            function fetchUser(callback) {
                $.getJSON('/api/auth/user', function (data) {
                    user = data;
                    console.log('✅ Logged-in user:', user);
                    if (user && user.liscense_plate) {
                        $('#reserve-plate').val(user.liscense_plate).prop('readonly', true);
                    }
                    if (callback) callback();
                }).fail(function (xhr) {
                    console.error('❌ Failed to fetch user:', xhr.responseText);
                    alert('Not logged in. Redirecting to login page.');
                    window.location.href = '/login';
                });
            }

            function fetchMaps(callback) {
                $.getJSON(`/api/maps/${locationId}`, function (data) {
                    mapData.maps = data.map(m => `/images/map/${m.floorsImageIndex}`);
                    mapData.floors = data.map(m => m.floor);
                    if (callback) callback();
                }).fail(function (xhr) {
                    alert('Failed to load maps for this location.');
                });
            }

            function fetchParkingSpaces(callback) {
                $.getJSON(`/api/parking/${locationId}`, function (data) {
                    parkingSpaces = data;
                    if (callback) callback();
                }).fail(function (xhr) {
                    console.error('❌ Failed to fetch parking spaces:', xhr.responseText);
                });
            }

            function loadFloor(index, containerSelector) {
                if (!mapData.floors.length) return;
                const floorValue = parseInt(mapData.floors[index], 10);
                const $container = $(containerSelector);
                $container.find('.map-image').attr('src', mapData.maps[index]);
                $('#floor-display').text(`Floor: ${mapData.floors[index]}`);
                $container.find('.parking-space').remove();

                const spacesToLoad = parkingSpaces.filter(s => s.floor === floorValue);
                spacesToLoad.forEach(space => {
                    const state = String(space.state).toLowerCase();
                    const exclusive = String(space.feature || '').toLowerCase();

                    // Base background colors based on state
                    let backgroundColor;
                    if (space.plate && user && space.plate === user.liscense_plate) {
                        // 💚 Highlight user's own reservation
                        backgroundColor = 'rgba(0, 255, 0, 0.6)';
                    } else {
                        switch (state) {
                            case 'taken':
                                backgroundColor = 'rgba(128,128,128,0.8)'; // gray
                                break;
                            case 'available':
                                backgroundColor = 'rgba(211,211,211,0.8)'; // light gray
                                break;
                            case 'unavailable':
                                backgroundColor = 'rgba(0,0,0,0.8)'; // black
                                break;
                            default:
                                backgroundColor = 'rgba(211,211,211,0.5)';
                        }
                    }


                    // Border color logic
                    let borderColor = 'transparent';
                    let borderWidth = '0px';
                    if (exclusive === 'employee') {
                        borderColor = 'red';
                        borderWidth = '3px';
                    } else if (exclusive === 'pwd') {
                        borderColor = 'lightblue';
                        borderWidth = '3px';
                    }

                    const spaceDiv = $('<div>', {
                        class: 'parking-space',
                        'data-index': space.index,
                        title: `Space #${space.index}\nType: ${space.feature}\nPrice: ${space.price}`
                    }).css({
                        position: 'absolute',
                        backgroundColor,
                        border: `${borderWidth} solid ${borderColor}`,
                        borderRadius: '3px',
                        top: `${space.locationY}%`,
                        left: `${space.locationX}%`,
                        width: `${space.sizeX}%`,
                        height: `${space.sizeY}%`,
                        cursor: 'pointer',
                        zIndex: 10
                    });

                    $container.append(spaceDiv);
                });


                updateButtonStates();
            }


            function updateButtonStates() {
                $('#floor-up').prop('disabled', currentFloorIndex >= mapData.floors.length - 1);
                $('#floor-down').prop('disabled', currentFloorIndex <= 0);
            }

            $('#floor-up').click(() => {
                if (currentFloorIndex < mapData.floors.length - 1) {
                    const oldSel = activeContainerSelector;
                    const newSel = (oldSel === '#map-container-1') ? '#map-container-2' : '#map-container-1';
                    currentFloorIndex++;
                    loadFloor(currentFloorIndex, newSel);
                    $(oldSel).hide(); $(newSel).show();
                    activeContainerSelector = newSel;
                }
            });

            $('#floor-down').click(() => {
                if (currentFloorIndex > 0) {
                    const oldSel = activeContainerSelector;
                    const newSel = (oldSel === '#map-container-1') ? '#map-container-2' : '#map-container-1';
                    currentFloorIndex--;
                    loadFloor(currentFloorIndex, newSel);
                    $(oldSel).hide(); $(newSel).show();
                    activeContainerSelector = newSel;
                }
            });

            $('#map-wrapper').on('click', '.parking-space', function () {
                const idx = $(this).data('index');
                const space = parkingSpaces.find(s => s.index === idx);
                if (!space) return;
                if (space.plate === user.liscense_plate) {
                    $('#reserve-submit').hide();
                    $('#cancel-reservation-btn').show();
                } else {
                    $('#reserve-submit').show();
                    $('#cancel-reservation-btn').hide();
                }

                $('#reserveModalLabel').text(`Space #${space.index}`);
                $('#reserve-space-info').html(`
          <p><strong>State:</strong> ${space.state}</p>
          <p><strong>Type:</strong> ${space.feature}</p>
          <p><strong>Price:</strong> PHP ${parseFloat(space.price).toFixed(2)}</p>
        `);

                $('#reserve-index').val(space.index);

                const available = String(space.state).toLowerCase() === 'available';
                if (available) {
                    $('#reserve-form-row').show();
                    $('#reserve-not-available').hide();
                    $('#reserve-submit').prop('disabled', false);
                    if (user?.liscense_plate) $('#reserve-plate').val(user.liscense_plate);
                } else {
                    $('#reserve-form-row').hide();
                    $('#reserve-not-available').show().text(`This space is ${space.state}.`);
                    $('#reserve-submit').prop('disabled', true);
                }

                $('#reserveModal').modal('show');
            });

            $('#reserve-submit').click(function (e) {
                e.preventDefault();
                const index = $('#reserve-index').val();
                const plate = user?.liscense_plate;
                const days = parseInt($('#reserve-days').val(), 10);

                if (!plate || !days || days <= 0) {
                    alert('Invalid user license plate or days.');
                    return;
                }

                $.ajax({
                    url: '/api/parking/reserve',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ index, plate, days }),
                    success: function () {
                        fetchParkingSpaces(() => loadFloor(currentFloorIndex, activeContainerSelector));
                        $('#reserveModal').modal('hide');
                    },
                    error: function (xhr) {
                        const msg = xhr.responseJSON?.error || xhr.statusText;
                        alert(msg);
                    }
                });
            });

            // Initialize in correct order
            fetchUser(function () {
                fetchMaps(function () {
                    fetchParkingSpaces(function () {
                        if (mapData.floors.length) {
                            loadFloor(currentFloorIndex, activeContainerSelector);
                            setInterval(() => {
                                fetchParkingSpaces(() => loadFloor(currentFloorIndex, activeContainerSelector));
                            }, 5000);
                        } else {
                            alert('No maps available for this location.');
                        }
                    });
                });
            });
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            $('#reserve-start-date').attr('min', minDate).val(minDate);

            // Automatically update end date when days or start date changes
            function updateEndDate() {
                const start = new Date($('#reserve-start-date').val());
                const days = parseInt($('#reserve-days').val(), 10);
                if (!isNaN(days)) {
                    const end = new Date(start);
                    end.setDate(start.getDate() + days);
                    $('#reserve-end-date').val(end.toLocaleDateString());
                }
            }

            $('#reserve-days, #reserve-start-date').on('input change', updateEndDate);
            updateEndDate();

            $('#cancel-reservation-btn').click(function () {
  const index = $('#reserve-index').val();
  $.ajax({
    url: '/api/parking/cancel',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ index }),
    success: function () {
      fetchParkingSpaces(() => loadFloor(currentFloorIndex, activeContainerSelector));
      $('#reserveModal').modal('hide');
    },
    error: function (xhr) {
      alert(xhr.responseJSON?.error || xhr.statusText);
    }
  });
});

        });
    </script>

    <div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="reserveModalLabel" class="modal-title">Reserve Space</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reserve-space-info"></div>
                    <div id="reserve-not-available" class="alert alert-warning" style="display:none;"></div>

                    <div id="reserve-form-row">
                        <div class="mb-2">
                            <label for="reserve-plate" class="form-label">License Plate</label>
                            <input id="reserve-plate" class="form-control" type="text" readonly>
                        </div>
                        <div class="mb-2">
                            <label for="reserve-days" class="form-label">Days to park</label>
                            <input id="reserve-days" class="form-control" type="number" min="1" value="1">
                        </div>
                        <div class="mb-2">
                            <label for="reserve-start-date" class="form-label">Start Date</label>
                            <input id="reserve-start-date" class="form-control" type="date" min="">
                        </div>
                        <div class="mb-2">
                            <label for="reserve-end-date" class="form-label">End Date</label>
                            <input id="reserve-end-date" class="form-control" type="text" readonly>
                        </div>
                    </div>

                    <input type="hidden" id="reserve-index">
                </div>
                <div class="modal-footer">
                    <button type="button" id="reserve-submit" class="btn btn-primary">Reserve</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="cancel-reservation-btn" class="btn btn-danger" style="display:none;">Cancel Reservation</button>

                </div>
            </div>
        </div>
    </div>
</body>

</html>