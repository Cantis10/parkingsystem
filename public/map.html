<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Parking Map</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/styles.css">

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .parking-space {
      position: absolute;
      background-color: rgba(0, 123, 255, 0.4);
      border: 2px solid blue;
      z-index: 10;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }

    .parking-space:hover {
      border-color: #ffc107;
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
    }

    .parking-space.state-taken {
      background-color: rgba(220, 53, 69, 0.6);
      border: 2px solid red;
    }

    .parking-space.state-available {
      background-color: rgba(40, 167, 69, 0.6);
      border: 2px solid green;
    }

    .parking-space.state-restricted {
      background-color: rgba(108, 117, 125, 0.6);
      border: 2px solid gray;
    }

    .parking-space.user-occupied {
      background-color: rgba(255, 215, 0, 0.8) !important;
      border: 3px solid gold !important;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
      animation: pulse-gold 2s infinite;
      z-index: 15 !important;
    }

    .parking-space-image {
      position: absolute;
      top: 3px;
      left: 3px;
      right: 3px;
      bottom: 3px;
      width: calc(100% - 6px);
      height: calc(100% - 6px);
      object-fit: contain;
      pointer-events: none;
    }

    @keyframes pulse-gold {

      0%,
      100% {
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
      }

      50% {
        box-shadow: 0 0 25px rgba(255, 215, 0, 1);
      }
    }

    .map-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .map-image {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Calendar modal styling */
    .modal-xl {
      max-width: 1200px;
    }

    #calendar {
      max-width: 100%;
      margin: 0 auto;
    }

    .date-input-helper {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }

    .overlap-warning {
      background-color: #f8d7da;
      border: 1px solid #f5c2c7;
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-top: 0.5rem;
    }

    .legend {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
    }

    .price-calculation {
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-top: 0.5rem;
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top rounded-bottom-lg">
    <div class="container-fluid">
      <a href="/home" class="btn btn-outline-light d-flex align-items-center me-auto" style="border:none;">
        <i class="fas fa-caret-left fa-lg me-1"></i> Back
      </a>
      <div class="ms-auto">
        <a class="navbar-brand d-flex align-items-center" href="#">Master Parker</a>
      </div>
    </div>
  </nav>

  <div class="mapContainer">
    <div class="map-main-container">
      <div id="map-wrapper" style="position:relative; padding-top:80px;">
        <img class="map-sizer" src="https://placehold.co/1200x800/transparent/000?text=Parking%20Map%20Sizer"
          alt="Map Sizing Element">
        <div id="map-container-1" class="map-container">
          <img class="map-image" src="images/map/placeHolder.png" alt="Parking Map">
        </div>
        <div id="map-container-2" class="map-container" style="display:none;">
          <img class="map-image" src="images/map/placeHolder.png" alt="Parking Map">
        </div>
      </div>
    </div>
  </div>

  <div class="floor-controls">
    <button id="floor-up" class="btn btn-primary shadow">▲</button>
    <div id="floor-display" class="shadow-sm">--</div>
    <button id="floor-down" class="btn btn-primary shadow">▼</button>
  </div>

  <!-- Calendar Reservation Modal -->
  <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="calendarModalLabel" class="modal-title">
            <i class="fas fa-calendar-alt"></i> Reserve Parking Space
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Space Info -->
          <div id="calendar-space-info" class="mb-3"></div>

          <!-- Legend -->
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color" style="background-color: #dc3545;"></div>
              <span>Restricted Dates</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #ffc107;"></div>
              <span>Occupied Dates</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #28a745;"></div>
              <span>Your Selection</span>
            </div>
          </div>

          <!-- Date Selection Form -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="calendar-start-date" class="form-label">Start Date</label>
              <input type="date" id="calendar-start-date" class="form-control">
              <div class="date-input-helper">
                <i class="fas fa-info-circle"></i> Or enter relative like "2 days"
              </div>
            </div>
            <div class="col-md-6">
              <label for="calendar-end-date" class="form-label">End Date</label>
              <input type="date" id="calendar-end-date" class="form-control">
              <div class="date-input-helper">
                <i class="fas fa-info-circle"></i> Or enter relative like "5 days"
              </div>
            </div>
          </div>

          <!-- Price Calculation -->
          <div id="price-calculation" class="price-calculation" style="display:none;">
            <h6><i class="fas fa-calculator"></i> Reservation Summary</h6>
            <p class="mb-1"><strong>Duration:</strong> <span id="calc-days">0</span> days</p>
            <p class="mb-1"><strong>Price per day:</strong> PHP <span id="calc-price-per-day">0.00</span></p>
            <p class="mb-0"><strong>Total Price:</strong> PHP <span id="calc-total-price">0.00</span></p>
          </div>

          <!-- Overlap Warning -->
          <div id="overlap-warning" class="overlap-warning" style="display:none;">
            <h6><i class="fas fa-exclamation-triangle"></i> Date Conflict</h6>
            <p id="overlap-message" class="mb-0"></p>
          </div>

          <!-- Calendar -->
          <div id="calendar" class="mt-3"></div>

          <input type="hidden" id="calendar-space-index" value="">
        </div>
        <div class="modal-footer">
          <button type="button" id="calendar-reserve-btn" class="btn btn-success">
            <i class="fas fa-check"></i> Confirm Reservation
          </button>
          <button type="button" id="calendar-cancel-btn" class="btn btn-danger" style="display:none;">
            <i class="fas fa-times"></i> Cancel Reservation
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <script>
    $(document).ready(function () {
      const urlParams = new URLSearchParams(window.location.search);
      const locationId = urlParams.get('location_id');
      if (!locationId) {
        alert('No location selected. Redirecting to home.');
        window.location.href = '/home';
        return;
      }

      let mapData = { maps: [], floors: [] };
      let parkingSpaces = [];
      let currentFloorIndex = 0;
      let activeContainerSelector = '#map-container-1';
      let userLicensePlate = '';
      let userSlotIndex = null;
      let calendar = null;
      let selectedSpace = null;
      let calendarEvents = [];
      let selectedStartDate = null;
      let selectedEndDate = null;

      function fetchUserData(callback) {
        $.ajax({
          url: '/api/auth/user',
          method: 'GET',
          success: function (data) {
            userLicensePlate = data.liscense_plate || '';
            userSlotIndex = data.slot_index_taken || null;
            console.log('User license plate loaded:', userLicensePlate);
            if (callback) callback();
          },
          error: function (xhr) {
            console.error('Failed to fetch user data:', xhr);
            alert('Failed to load user information. Please log in again.');
            window.location.href = '/login';
          }
        });
      }

      function fetchMaps(callback) {
        $.ajax({
          url: `/api/maps/${locationId}`,
          method: 'GET',
          dataType: 'json',
          success: function (data) {
            mapData.maps = data.map(m => `/images/map/${m.floorsImageIndex}`);
            mapData.floors = data.map(m => m.floor);
            if (callback) callback();
          },
          error: function (xhr, status, error) {
            console.error('Failed to fetch maps:', error);
            alert('Failed to load maps for this location.');
          }
        });
      }

      function fetchParkingSpaces(callback) {
        $.ajax({
          url: `/api/parking/${locationId}`,
          method: 'GET',
          success: function (data) {
            parkingSpaces = data;
            if (callback) callback();
          },
          error: function (xhr) {
            console.error('Failed to fetch parking spaces:', xhr);
          }
        });
      }

      function loadFloor(index, containerSelector) {
        if (mapData.floors.length === 0) return;

        const floor = mapData.floors[index];
        const $container = $(containerSelector);

        $container.find('.map-image').attr('src', mapData.maps[index]);
        $('#floor-display').text(`Floor: ${floor}`);
        $container.find('.parking-space').remove();

        parkingSpaces.forEach(space => {
          const isUserSpace = (userSlotIndex && space.index == userSlotIndex) ||
            (userLicensePlate && space.plate === userLicensePlate);

          const isHorizontal = space.sizeX > space.sizeY;
          const carImage = isHorizontal ? '/images/map/carHorizontal.png' : '/images/map/carVertical.png';

          const spaceDiv = $('<div>', {
            'class': `parking-space state-${space.state} ${isUserSpace ? 'user-occupied' : ''}`,
            'data-index': space.index,
            'title': `Space #${space.index} | Floor: ${space.floor} | State: ${space.state} | Type: ${space.feature} | Price: PHP ${parseFloat(space.price).toFixed(2)}${isUserSpace ? ' | YOUR SPACE' : ''}`
          }).css({
            top: `${space.locationY}%`,
            left: `${space.locationX}%`,
            width: `${space.sizeX}%`,
            height: `${space.sizeY}%`
          });

          if (space.state.toLowerCase() === 'taken') {
            const carImg = $('<img>', {
              'class': 'parking-space-image',
              'src': carImage,
              'alt': 'Car'
            });
            spaceDiv.append(carImg);
          }

          $container.append(spaceDiv);
        });

        $container.find('.parking-space').tooltip({
          content: function () { return $(this).prop('title'); }
        });

        updateButtonStates();
      }

      function updateButtonStates() {
        $('#floor-up').prop('disabled', currentFloorIndex >= mapData.floors.length - 1);
        $('#floor-down').prop('disabled', currentFloorIndex <= 0);
      }

      $('#floor-up, #floor-down').on('click', function () {
        const isUp = $(this).attr('id') === 'floor-up';
        if ((isUp && currentFloorIndex >= mapData.floors.length - 1) || (!isUp && currentFloorIndex <= 0)) return;

        const newContainer = (activeContainerSelector === '#map-container-1') ? '#map-container-2' : '#map-container-1';
        currentFloorIndex += isUp ? 1 : -1;
        loadFloor(currentFloorIndex, newContainer);
        $(activeContainerSelector).hide();
        $(newContainer).show();
        activeContainerSelector = newContainer;
      });

      // Initialize FullCalendar
      function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          selectable: true,
          selectMirror: true,
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
          },
          select: function (info) {
            selectedStartDate = info.startStr;
            // Subtract 1 day from end because FullCalendar's end is exclusive
            selectedEndDate = new Date(info.end.getTime() - 86400000).toISOString().split('T')[0];
            $('#calendar-start-date').val(selectedStartDate);
            $('#calendar-end-date').val(selectedEndDate);
            checkOverlaps();
            calculatePrice();
          },
          events: []
        });
        calendar.render();
      }

      

      $('#calendar-cancel-btn').on('click', function () {
        const btn = $(this);
        const spaceIndex = $('#calendar-space-index').val();

        if (!confirm('Are you sure you want to cancel your reservation?')) {
          return;
        }

        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Canceling...');

        $.ajax({
          url: '/api/parking/cancel-calendar',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            index: spaceIndex
          }),
          success: function (response) {
            $('#calendarModal').modal('hide');

            // Refresh the map data
            fetchUserData(function () {
              fetchParkingSpaces(function () {
                loadFloor(currentFloorIndex, activeContainerSelector);
                // Also refresh calendar data if needed
                loadCalendarData(spaceIndex);
              });
            });

            alert('Reservation canceled successfully');
          },
          error: function (xhr) {
            let msg = 'Failed to cancel reservation';
            try {
              const json = xhr.responseJSON;
              if (json && json.error) msg = json.error;
            } catch (e) {
              msg = xhr.statusText || msg;
            }
            alert(msg);
            btn.prop('disabled', false)
              .html('<i class="fas fa-times"></i> Cancel Reservation');
          }
        });
      });

      // Load calendar data from API
      function loadCalendarData(spaceIndex) {
        const today = new Date();
        const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);

        $.ajax({
          url: `/api/parking/calendar/${spaceIndex}`,
          method: 'GET',
          data: {
            start: today.toISOString().split('T')[0],
            end: threeMonthsLater.toISOString().split('T')[0]
          },
          success: function (data) {
            console.log('Raw calendar data:', data);

            // Process events to ensure proper end dates
            calendarEvents = (data.events || []).map(event => {
              // Create a new event object with processed dates
              const processedEvent = {
                ...event,
                start: event.start,
                // Add 1 day to end date since FullCalendar uses exclusive end dates
                end: new Date(new Date(event.end).getTime() + 24 * 60 * 60 * 1000).toISOString().split('T')[0]
              };

              console.log('Processed event:', {
                title: processedEvent.title,
                start: processedEvent.start,
                end: processedEvent.end,
                type: processedEvent.type
              });

              return processedEvent;
            });

            if (calendar) {
              calendar.removeAllEvents();
              calendar.addEventSource(calendarEvents);
            }
          },
          error: function (xhr) {
            console.error('Failed to load calendar data:', xhr);
            calendarEvents = [];
          }
        });
      }

      function checkOverlaps() {
        if (!selectedStartDate || !selectedEndDate) {
          $('#overlap-warning').hide();
          return false;
        }

        console.log('Checking overlaps for dates:', {
          start: selectedStartDate,
          end: selectedEndDate
        });

        const overlaps = calendarEvents.filter(event => {
          // Normalize event end date by subtracting the extra day we added for display
          const eventEnd = new Date(event.end);
          eventEnd.setDate(eventEnd.getDate() - 1);
          const normalizedEventEnd = eventEnd.toISOString().split('T')[0];

          const hasOverlap = dateRangesOverlap(
            selectedStartDate,
            selectedEndDate,
            event.start,
            normalizedEventEnd
          );

          console.log('Checking event:', {
            eventTitle: event.title,
            eventStart: event.start,
            eventEnd: normalizedEventEnd,
            hasOverlap: hasOverlap
          });

          return hasOverlap;
        });

        if (overlaps.length > 0) {
          // ... rest of overlap handling code ...
          const messages = overlaps.map(o => {
            // Normalize display end date
            const eventEnd = new Date(o.end);
            eventEnd.setDate(eventEnd.getDate() - 1);
            const displayEnd = eventEnd.toISOString().split('T')[0];

            if (o.type === 'restriction') {
              return `• Restricted period: ${o.start} to ${displayEnd}`;
            } else {
              return `• Occupied by ${o.extendedProps?.username || 'another user'}: ${o.start} to ${displayEnd}`;
            }
          });

          $('#overlap-message').html(messages.join('<br>'));
          $('#overlap-warning').show();
          $('#calendar-reserve-btn').prop('disabled', true);

          if (calendar) {
            calendar.removeAllEvents();
            calendar.addEventSource(calendarEvents);
            calendar.addEvent({
              title: 'CONFLICT',
              start: selectedStartDate,
              end: addDays(selectedEndDate, 1), // Add day for exclusive end date
              color: '#ff0000',
              textColor: 'white'
            });
          }

          return true;
        } else {
          $('#overlap-warning').hide();
          $('#calendar-reserve-btn').prop('disabled', false);

          // Show selection in green
          if (calendar) {
            calendar.removeAllEvents();
            calendar.addEventSource(calendarEvents);
            calendar.addEvent({
              title: 'Your Reservation',
              start: selectedStartDate,
              end: addDays(selectedEndDate, 1),
              color: '#28a745',
              textColor: 'white'
            });
          }

          return false;
        }
      }

      // Calculate price
      function calculatePrice() {
        if (!selectedStartDate || !selectedEndDate || !selectedSpace) {
          $('#price-calculation').hide();
          return;
        }

        const start = new Date(selectedStartDate);
        const end = new Date(selectedEndDate);
        const diffTime = Math.abs(end - start);
        const days = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
        const pricePerDay = parseFloat(selectedSpace.price);
        const totalPrice = pricePerDay * days;

        $('#calc-days').text(days);
        $('#calc-total-price').text(totalPrice.toFixed(2));
        $('#price-calculation').show();
      }

      // Date input change handlers
      $('#calendar-start-date, #calendar-end-date').on('change', function () {
        selectedStartDate = $('#calendar-start-date').val();
        selectedEndDate = $('#calendar-end-date').val();

        if (selectedStartDate && selectedEndDate) {
          checkOverlaps();
          calculatePrice();
        }
      });

      // Helper function to add days
      function addDays(dateStr, days) {
        const date = new Date(dateStr);
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
      }

      // Check date range overlap
      function dateRangesOverlap(start1, end1, start2, end2) {
        const s1 = new Date(start1);
        const e1 = new Date(end1);
        const s2 = new Date(start2);
        const e2 = new Date(end2);
        return s1 <= e2 && s2 <= e1;
      }

      // Confirm reservation
      $('#calendar-reserve-btn').on('click', function () {
        if (!selectedStartDate || !selectedEndDate || !selectedSpace) {
          alert('Please select start and end dates');
          return;
        }

        const hasOverlap = checkOverlaps();
        if (hasOverlap) {
          alert('Cannot reserve: Selected dates overlap with restricted or occupied periods');
          return;
        }

        const btn = $(this);
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Reserving...');

        $.ajax({
          url: '/api/parking/reserve-calendar',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            index: selectedSpace.index,
            startDate: selectedStartDate,
            endDate: selectedEndDate
          }),
          success: function (response) {
            alert(`Reservation successful!\n\nDuration: ${response.reservation.days} days\nTotal: PHP ${response.reservation.totalPrice}`);
            $('#calendarModal').modal('hide');

            fetchUserData(function () {
              fetchParkingSpaces(function () {
                loadFloor(currentFloorIndex, activeContainerSelector);
              });
            });
          },
          error: function (xhr) {
            let msg = 'Failed to create reservation';
            try {
              const json = xhr.responseJSON;
              if (json && json.error) {
                msg = json.error;
              }
            } catch (e) {
              msg = xhr.statusText || msg;
            }
            alert(msg);
            btn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm Reservation');
          }
        });
      });

      // Initialize
      initCalendar();
      fetchUserData(function () {
        fetchMaps(function () {
          fetchParkingSpaces(function () {
            if (mapData.floors.length > 0) {
              loadFloor(currentFloorIndex, activeContainerSelector);
            } else {
              alert('No maps available for this location.');
            }
          });
        });
      });
    });
  </script>

</body>

</html>